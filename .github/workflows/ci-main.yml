# .github/workflows/ci-main.yml
# =============================================================
# CI - Main Build & Push – VERSION ULTIME  (steps + matrix)
# → 6 services en parallèle
# → Cache Docker ultra-rapide
# → Slack parfait
# → Tu ajoutes un service → 1 ligne dans la matrix
# =============================================================

name: CI - Main Build & Push

on:
  push:
    branches: [ main ]

concurrency:
  group: ci-main
  cancel-in-progress: true

jobs:
  build-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [gateway, auth, project, billing, notification, analytics]
      # Un seul build à la fois pour éviter la limite de pull rate Docker Hub
      max-parallel: 1

    name: Build → ${{ matrix.service }}

    steps:
      # 1. Checkout du code (obligatoire pour le cache Docker)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Docker Buildx avec authentification
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      # 2b. Cache GitHub Actions pour les layers Docker (évite de repuller les images de base)
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-
            ${{ runner.os }}-buildx-

      # 3. Login GitHub Container Registry (pas de limite de pull rate)
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # 3b. Login Docker Hub aussi (pour les images de base comme python:3.11-slim)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: false

      # 4. Attendre un peu pour éviter de dépasser la limite de pull rate
      # Délai basé sur l'index du service dans la matrix
      - name: Wait to avoid rate limit
        run: |
          # Calculer un délai basé sur l'index du service (0-5)
          services=("gateway" "auth" "project" "billing" "notification" "analytics")
          index=0
          for i in "${!services[@]}"; do
            if [ "${services[$i]}" == "${{ matrix.service }}" ]; then
              index=$i
              break
            fi
          done
          # Attendre 30 secondes par service pour espacer les pulls
          delay=$((index * 30))
          echo "Attente de ${delay} secondes pour éviter la limite de pull rate..."
          sleep $delay

      # 5. Convertir le nom du repository owner en minuscules (requis par ghcr.io)
      - name: Set lowercase repository owner
        id: repo
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner=$REPO_OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "Repository owner (lowercase): $REPO_OWNER_LOWER"

      # 6. Build & Push vers GitHub Container Registry (ghcr.io)
      - name: Build & Push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ./services/${{ matrix.service }}
          push: true
          tags: |
            ghcr.io/${{ steps.repo.outputs.owner }}/cloudtaskhub-${{ matrix.service }}:latest
            ghcr.io/${{ steps.repo.outputs.owner }}/cloudtaskhub-${{ matrix.service }}:${{ github.sha }}
          cache-from: |
            type=registry,ref=ghcr.io/${{ steps.repo.outputs.owner }}/cloudtaskhub-${{ matrix.service }}:latest
            type=local,src=/tmp/.buildx-cache
          cache-to: |
            type=local,dest=/tmp/.buildx-cache-new,mode=max
            type=registry,ref=ghcr.io/${{ steps.repo.outputs.owner }}/cloudtaskhub-${{ matrix.service }}:latest,mode=max
          platforms: linux/amd64
      
      # 6b. Déplacer le cache pour le prochain build
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # 7. Scan sécurité (optionnel mais pro)
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ steps.repo.outputs.owner }}/cloudtaskhub-${{ matrix.service }}:latest
          format: table
          exit-code: 1
          ignore-unfixed: true
          severity: CRITICAL,HIGH

  # =============================================================
  # Slack – failure notification
  # =============================================================
  slack-failure:
    needs: build-all
    if: ${{ github.event_name == 'push' && failure() }}
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: failure
      title: "Le Build ❌ sur main a échoué"
      message: |
        Auteur : ${{ github.actor }}
        Lien : https://github.com/${{ github.repository }}/commit/${{ github.sha }}
    secrets: inherit  

  # =============================================================
  # 4. Notification Slack (success)
  # =============================================================
  slack-success:
    needs:  build-all
    if: ${{ github.event_name == 'push' && success() }}
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: success
      title: "Le Build ✅ sur main a réussi"
      message: |
        Tous les services ont été build avec succès !
        Auteur : ${{ github.actor }}
        Lien : https://github.com/${{ github.repository }}/commit/${{ github.sha }}
    secrets: inherit
