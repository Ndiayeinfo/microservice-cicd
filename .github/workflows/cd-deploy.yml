# .github/workflows/cd-deploy.yml
# =============================================================
# CD - Déploiement AUTOMATIQUE – VERSION ULTIME 2025
# → Clone le repo s'il n'existe pas
# → Pull à chaque fois
# → Déploie avec le bon tag d'image
# → Zero bug, zero maintenance
# =============================================================

name: CD - Deploy Production

on:
  workflow_run:
    workflows: ["CI - Main Build & Push"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: SSH → Clone/Pull + Déploiement auto
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 90s
          script: |
            set -e

            echo "Connexion SSH réussie sur $(hostname)"

            # Dossier du projet
            cd /opt

            # Clone si pas déjà là, sinon pull
            if [ ! -d "cloudtaskhub" ]; then
              echo "Premier déploiement → git clone..."
              git clone https://github.com/${{ github.repository }}.git cloudtaskhub
            fi

            cd cloudtaskhub
            echo "Mise à jour du code..."
            git checkout main
            git pull origin main

            # Optionnel : on force le tag latest (ou tu peux utiliser le SHA)
            echo "IMAGE_TAG=latest" > .env
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env

            # Déploiement Swarm
            echo "Déploiement en cours..."
            docker stack deploy \
              -c docker-compose.prod.yml \
              cloudtaskhub \
              --with-registry-auth \
              --resolve-image changed \
              --prune

            echo "DÉPLOIEMENT TERMINÉ AVEC SUCCÈS !"
            docker stack ps cloudtaskhub --no-trunc
            docker service ls

      # Slack – Succès
      - name: Slack – Déploiement réussi
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "Déploiement en prod réussi (auto clone/pull)" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Slack – Échec
      - name: Slack – Déploiement échoué
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "ÉCHEC du déploiement en prod" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}