# =============================================================
# CD - Déploiement AUTOMATIQUE
# Repo : donaldte/microservice-cicd
# Déploie automatiquement sur ton serveur Docker Swarm
# =============================================================

name: CD - Deploy Production

on:
  # Déclenchement automatique après succès du CI
  workflow_run:
    workflows: ["CI - Main Build & Push"]
    types: [completed]
    branches: [main]
  # Déclenchement manuel (optionnel)
  workflow_dispatch:

jobs:
  deploy:
    # Se déclenche si :
    # - Le workflow CI a réussi (workflow_run)
    # - OU si déclenché manuellement (workflow_dispatch)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Swarm via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "Connexion réussie sur $(hostname)"

            # Créer le répertoire s'il n'existe pas
            mkdir -p /opt/cloudtaskhub
            cd /opt/cloudtaskhub

            # Vérifier si c'est un repository Git
            if [ -d .git ]; then
              echo "Repository Git trouvé, mise à jour du code..."
              git fetch --all
              git reset --hard origin/main
              git clean -fd
            else
              echo "Repository Git non trouvé, clonage du projet..."
              # Supprimer le contenu s'il existe (mais pas le répertoire)
              rm -rf /opt/cloudtaskhub/* /opt/cloudtaskhub/.* 2>/dev/null || true
              # Cloner le repository (fonctionne pour public et privé avec token si nécessaire)
              # Pour les repos privés, vous devrez configurer un token GitHub dans les secrets
              if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
                git clone https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git /opt/cloudtaskhub
              else
                git clone https://github.com/${{ github.repository }}.git /opt/cloudtaskhub
              fi
              cd /opt/cloudtaskhub
              git checkout main
            fi

            # CRÉATION DES RÉSEAUX AVEC SUBNET FIXE 
            echo "Création des réseaux overlay avec subnets fixes..."
            docker network create --driver overlay --attachable --subnet=172.20.0.0/16 traefik-public || true
            docker network create --driver overlay --attachable --subnet=172.21.0.0/16 internal || true

            # CRÉER LE FICHIER .env.prod (nécessaire pour docker-compose.prod.yml)
            echo "Création du fichier .env.prod..."
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" > /opt/cloudtaskhub/.env.prod
            echo "IMAGE_TAG=latest" >> /opt/cloudtaskhub/.env.prod

            # Vérifier que le fichier a été créé
            echo "Contenu de .env.prod :"
            cat /opt/cloudtaskhub/.env.prod

            # VÉRIFIER QUE LES FICHIERS PROMETHEUS EXISTENT
            echo "Vérification des fichiers Prometheus..."
            ls -la /opt/cloudtaskhub/prometheus*.yml || echo "Aucun fichier prometheus trouvé"
            
            # Si prometheus-alerts.yml n'existe pas, créer un fichier minimal valide
            if [ ! -f /opt/cloudtaskhub/prometheus-alerts.yml ]; then
              echo "Création du fichier prometheus-alerts.yml (vide par défaut)..."
              cat > /opt/cloudtaskhub/prometheus-alerts.yml << 'EOF'
groups:
  - name: cloudtaskhub_alerts
    interval: 30s
    rules: []
EOF
            fi
            
            # Vérifier la syntaxe YAML basique
            echo "Vérification de la syntaxe des fichiers..."
            python3 -c "import yaml; yaml.safe_load(open('/opt/cloudtaskhub/prometheus.yml'))" 2>/dev/null || echo "Warning: Impossible de valider prometheus.yml"
            python3 -c "import yaml; yaml.safe_load(open('/opt/cloudtaskhub/prometheus-alerts.yml'))" 2>/dev/null || echo "Warning: Impossible de valider prometheus-alerts.yml"

            # Charger les variables d'environnement depuis .env.prod
            # Docker Swarm nécessite que les variables soient dans l'environnement
            export $(cat /opt/cloudtaskhub/.env.prod | xargs)

            # Vérifier que les variables sont chargées
            echo "Variables d'environnement chargées :"
            echo "DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME"
            echo "IMAGE_TAG=$IMAGE_TAG"

            echo "Déploiement du stack..."
            docker stack deploy -c docker-compose.prod.yml cloudtaskhub --with-registry-auth --prune

            echo "DÉPLOIEMENT TERMINÉ !"
            echo "Services :"
            docker service ls
            echo "Tâches :"
            docker stack ps cloudtaskhub --no-trunc


  # =============================================================
  # 3. Notification Slack en cas d’échec
  # =============================================================
  slack-failure:
    needs: deploy
    if: failure()                             # seulement si les tests ont planté
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: failure
      title: "Le Deploy du PR ❌ a échoué"
      message: |
        Auteur : ${{ github.actor }}
    secrets: inherit

  # =============================================================
  # 4. Notification Slack si tout est bon
  # =============================================================
  slack-success:
    needs:  deploy
    if: success()
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: success
      title: "Le Build du PR ✅  a réussi"
      message: |
        Le déploiement a réussi !
        Auteur : ${{ github.actor }}
    secrets: inherit
